<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=5.0, user-scalable=yes"
  />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#fff4f2" />
  <meta name="description" content="Voice Training Companion - Practice pitch control while reading texts" />
  <meta name="author" content="Voice Training App" />

  <!-- Open Graph -->
  <meta property="og:title" content="Voice Training Companion" />
  <meta property="og:description" content="Practice voice pitch and resonance with real-time feedback" />
  <meta property="og:type" content="website" />

  <title>Voice Training Companion - Reading Edition</title>

  <!-- PWA Manifest -->
  <link
    rel="manifest"
    href="data:application/json;base64,eyJuYW1lIjoiVm9pY2UgVHJhaW5pbmcgQ29tcGFuaW9uIiwic2hvcnRfbmFtZSI6IlZvaWNlVHJhaW5lciIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmNGYyIiwidGhlbWVfY29sb3IiOiIjZmZmNGYyIiwib3JpZW50YXRpb24iOiJhbnkiLCJpY29ucyI6W119"
  />

  <!-- SVL favicon (optional) -->
  <link rel="icon" href="https://www.seattlevoicelab.com/wp-content/uploads/2023/05/favic-150x150.png" sizes="32x32" />

  <!-- OPTIONAL: Headline font (uncomment to use Averia Serif Libre like parts of the site) -->
  <!--
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Averia+Serif+Libre:wght@400;700&display=swap" rel="stylesheet">
  -->

  <!-- Tailwind config BEFORE the CDN script -->
  <script>
    tailwind = {
      theme: {
        extend: {
          colors: {
            svl: {
              beige:  '#fff4f2',
              purple: '#904dff',
              pink:   '#ffa2fe',
              orange: '#ff722f',
              yellow: '#fdd55a',
              grey:   '#3b1e36',
              blue:   '#6f81ff'
            }
          },
          fontFamily: {
            // Body/UI font: fast, looks close to SVL site
            brand: [
              'var(--svl-font, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Apple Color Emoji, Segoe UI Emoji)'
            ],
            // Headings accent (use Averia if enabled above)
            display: [
              'var(--svl-display, var(--svl-font, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto))'
            ]
          }
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React / Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      /* Default fonts; set these to switch site-wide typography */
      --svl-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, 'Helvetica Neue', Helvetica, 'Apple Color Emoji','Segoe UI Emoji';
      /* If you uncomment the Google Font above, set this to: 'Averia Serif Libre', Georgia, serif */
      --svl-display: var(--svl-font);
    }

    /* ---------- Fit-to-screen app shell ---------- */
    html, body { height: 100%; margin: 0; overflow: hidden; }
    #root { height: 100%; }
    .app-shell {
      height: 100dvh; min-height: 100dvh;
      display: grid; grid-template-rows: auto 1fr;
    }
    .main-area { overflow: auto; -webkit-overflow-scrolling: touch; }
    .panel, .reader-panel { height: 100%; min-height: 0; display: flex; flex-direction: column; overflow: auto; }
    .reader-content { flex: 1 1 auto; min-height: 0; overflow: auto; }

    /* Reading typography */
    .reading-text {
      font-family: var(--svl-font);
      line-height: 2; letter-spacing: 0.05em; word-spacing: 0.2em;
    }

    /* Smooth scrolling */
    html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }

    /* Touch targets */
    button, select, input, textarea { min-height: 44px; min-width: 44px; }

    /* Floating bubble */
    .floating-bubble { position: fixed; right: 20px; bottom: 80px; z-index: 1000; animation: float 3s ease-in-out infinite; }
    @media (min-width: 768px) { .floating-bubble { right: 30px; bottom: 30px; } }
    @media (min-width: 1024px) { .floating-bubble { right: 40px; bottom: 40px; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    .pitch-indicator { transition: all 0.3s ease; }

    /* Prevent accidental selection / highlights */
    button, select { user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

    /* iOS safe areas */
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

    /* Desktop container width */
    @media (min-width: 1024px) { .desktop-container { max-width: 1200px; margin: 0 auto; } }

    /* High contrast */
    @media (prefers-contrast: high) { button { border: 2px solid currentColor; } }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
    }

    /* Print */
    @media print {
      .floating-bubble, button, select { display: none !important; }
      .reading-text { color: black !important; background: white !important; }
    }

    /* Slider track/thumb (brand hint) */
    input[type="range"]{
      accent-color: #904dff; /* purple */
    }
  </style>
</head>
<body class="font-brand bg-svl-beige text-svl-grey">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    function VoiceTrainingReader() {
      const [isDronePlaying, setIsDronePlaying] = useState(false);
      const [selectedNote, setSelectedNote] = useState('C4');
      const [currentPitch, setCurrentPitch] = useState(0);
      const [micPermission, setMicPermission] = useState('pending');
      const [audioInitialized, setAudioInitialized] = useState(false);
      const [showBubble, setShowBubble] = useState(false);
      const [bubbleExpanded, setBubbleExpanded] = useState(false);
      const [selectedReading, setSelectedReading] = useState(null);
      const [fontSize, setFontSize] = useState('large');

      // üîä Volume (0‚Äì2.0), persisted
      const [volume, setVolume] = useState(() => {
        try {
          const saved = localStorage.getItem('vt_volume');
          const v = saved ? parseFloat(saved) : 0.8; // 80% default
          return Number.isFinite(v) ? Math.min(2, Math.max(0, v)) : 0.8;
        } catch { return 0.8; }
      });

      // Audio graph
      const audioContextRef = useRef(null);
      const oscillatorRef = useRef(null);
      const compressorRef = useRef(null);
      const gainNodeRef = useRef(null);
      const analyserRef = useRef(null);
      const micStreamRef = useRef(null);
      const pitchDetectionRef = useRef(null);

      const notes = {
        'A3': 220.00, 'B3': 246.94, 'C4': 261.63, 'C#4': 277.18, 'D4': 293.66,
        'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00
      };

      // üìö Readings (includes full Rainbow + fem monologues)
      const readings = [
        {
          id: 'rainbow',
          title: 'üåà Rainbow Passage',
          description: 'Classic voice training text',
          content: `When the sunlight strikes raindrops in the air, they act as a prism and form a rainbow. The rainbow is a division of white light into many beautiful colors. These take the shape of a long round arch, with its path high above, and its two ends apparently beyond the horizon. There is, according to legend, a boiling pot of gold at one end. People look, but no one ever finds it. When a person looks for something beyond their reach, their friends say they are looking for the pot of gold at the end of the rainbow.

Throughout the centuries people have explained the rainbow in various ways. Some have accepted it as a miracle without physical explanation. Others have tried to explain the phenomenon physically. Aristotle thought that the rainbow was caused by reflection of the sun's rays by the rain. Since then physicists have found that it is not reflection, but refraction by the raindrops which causes the rainbows.

Many complicated ideas about the rainbow have been formed. The difference in the rainbow depends considerably upon the size of the drops, and the width of the colored band increases as the size of the drops increases. The actual primary rainbow observed is said to be the effect of superimposition of a number of bows. If the red of the second bow falls upon the green of the first, the result is a bow with an abnormally wide yellow band, since red and green light when mixed form yellow. This is a very common type of bow, one showing mainly red and yellow, with little or no green or blue.`
        },
        {
          id: 'quick',
          title: '‚ö° Quick Practice Sentences',
          description: 'Short sentences for warm-up',
          content: `The early morning brings new opportunities.

She speaks with confidence and clarity.

My voice flows naturally and freely.

Practice makes progress, not perfection.

Each day I grow more comfortable with my voice.

Speaking authentically is my goal.

The melody of speech comes from within.

I embrace my unique vocal qualities.`
        },

        // üéà Bouncy Voice
        {
          id: 'bouncy-lady-mary',
          title: 'üéà Bouncy Voice ‚Äî Lady Mary (The Admirable Crichton)',
          description: 'Energy & lift; playful bounce',
          content: `I sighted a herd near Penguin‚Äôs Creek, but had to creep round Silver Lake to get
to windward of them. However, they spotted me and then the fun began. There
was nothing for it but to try and run them down, so I singled out a fat buck and
away we went down the shore of the lake, up the valley of rolling stones; he
doubled into Brawling River and took to the water, but I swam after him; the
river is only half a mile broad there, but it runs strong. He went spinning down
the rapids, down I went in pursuit; he clambered ashore, I clambered ashore;
away we tore helter-skelter up the hill and down again. I lost him in the
marshes, got on his track again near Bread Fruit Wood, and brought him down
with an arrow in Firefly Grove.`
        },
        {
          id: 'bouncy-lucy',
          title: 'üéà Bouncy Voice ‚Äî Lucy Van Pelt (You‚Äôre A Good Man, Charlie Brown)',
          description: 'Playful authority; light staccato',
          content: `Do you know what I intend? I intend to be a queen. When I grow up I‚Äôm going
to be the biggest queen there ever was, and I‚Äôll live in a big palace and when I
go out in my coach, all the people will wave and I will shout at them,
and...and...in the summertime I will go to my summer palace and I‚Äôll wear my
crown in swimming and everything, and all the people will cheer and I will
shout at them... What do you mean I can‚Äôt be queen? Nobody should be kept
from being a queen if she wants to be one. It‚Äôs usually just a matter of knowing
the right people.. ..well.... if I can‚Äôt be a queen, then I‚Äôll be very rich then I will
buy myself a queendom. Yes, I will buy myself a queendom and then I‚Äôll kick
out the old queen and take over the whole operation myself. I will be head
queen.`
        },

        // ‚è±Ô∏è Tempo Variance
        {
          id: 'tempo-sally',
          title: '‚è±Ô∏è Tempo Variance ‚Äî Sally Brown (You‚Äôre A Good Man, Charlie Brown)',
          description: 'Speed/play with pauses',
          content: `A 'C'? A 'C'? I got a 'C' on my coathanger sculpture? How could anyone get a 'C'
in coathanger sculpture? May I ask a question? Was I judged on the piece of
sculpture itself? If so, is it not true that time alone can judge a work of art? Or
was I judged on my talent? If so, is it fair that I be judged on a part of my life over
which I have no control? If I was judged on my effort, then I was judged unfairly,
for I tried as hard as I could! Was I judged on what I had learned about this
project? If so, then were not you, my teacher, also being judged on your ability to
transmit your knowledge to me? Are you willing to share my 'C'? Perhaps I was
being judged on the quality of coathanger itself out of which my creation was
made...now is this not also unfair? Am I to be judged by the quality of coat
hangers that are used by the drycleaning establishment that returns our
garments? Is that not the responsibility of my parents? Should they not share my
'C'?`
        },
        {
          id: 'tempo-beatrix',
          title: '‚è±Ô∏è Tempo Variance ‚Äî Beatrix (Promedy)',
          description: 'Stretch & compress phrases',
          content: `Young women need the Prom. It's a rite of passage as sacred as getting your
driver's license or buying your first bra. There are only a few things in life that are
guaranteed to be glorious and memorable and sparkling with gowns and
cumberbunds. Prom is the quintessential teenage experience. Think of the
unlucky grown-ups and the elderly who lament the day they decided not to go to
the Prom. It is a key ingredient to a happy and meaningful life. Prom is short for
Promenade, a slow, gentle walk through a shady glen, and this beloved
ceremony symbolizes our journey from the shadows of adolescence to the bright
sunshine of the adult world with all its freedoms. And it may be the only chance
I'll ever have to dance with someone. Maybe I'll never have someone get down
on a knee and offer me a diamond ring. Maybe I'll never walk down the aisle with
a smug look of bridal triumph. But it is my right, and the right of every
book-wormy, soon-to-be librarian to have one night of Cinderella magic. Even if
we have to go with our cousin, or our gay best friend from tap class, we will have
a Prom. And you will help me.`
        },

        // üó£Ô∏è Vowel Elongation
        {
          id: 'vowel-winnie',
          title: 'üó£Ô∏è Vowel Elongation ‚Äî Sister Winnie (Folk)',
          description: 'Hold vowels; smooth airflow',
          content: `Oh, it was fine. I mean: not fine fine ‚Äì everything's... I've been at the hospital,
Kayleigh. I don't know if Stephen said. Getting some tests done. I've got angina.
Which for some reason I keep calling: vagina. It doesn't help. It means, Kayleigh,
no more fun. No more drinking, no more getting worked up, no more smoking,
apparently ‚Äì I'm ignoring that, obviously but. I'm getting pills, blood-thinners.
They've showered me with leaflets. The consultant basically said I could pop my
clogs at any moment. Added to which: he was a very pale man, heavy-breather ‚Äì
I did wonder briefly if he might actually be Death, come to get me. But then one
of the other doctors popped in, called him Nigel, mentioned something about
badminton so I thought: probably not. It's hard to imagine the Grim Reaper with a
shuttlecock. But that's not the worst bit, Stephen. Picture this: I've been through
all the sitting, the waiting, been wired up to a monitor, jogged, et cetera, I've been
jiggled about, prodded, pressed with some very chilly instruments, got released,
finally, back into the world, with my clogged-up arteries and uncertain future, I'm
in the lift going down, who should get into the lift with me on floor number seven?
I'll give you a clue: he's got a fucking hernia. And did he ask how I was? No. He
spotted me, took a deep breath, launched into another two-hour rant about what
a rough deal it is ‚Äì complaining, whining. I mean, I know it's not nice to have a bit
of your stomach lining poking out, I get it, I do, but really ‚Äì how much more is
there to say?`
        },
        {
          id: 'vowel-sophia',
          title: 'üó£Ô∏è Vowel Elongation ‚Äî Sophia (Girlboss)',
          description: 'Lengthen key vowels',
          content: `Adulthood is where dreams go to die. Grow up, get a job, become a drone, that's
it. Then it's over. Society just wants to put everyone in a box. Well guess what
society? There is no box. Cos I mean, if I thought the rest of my life would be
spent as a mindless cog in a machine, I swear I'd just get a tattoo across my face
that says: "Really man?" Just need to figure out a way of growing up without
becoming a boring adult. You probably think I'm some spoiled brat who's never
had it hard cause I didn't have to walk a mile to school. But here's the thing, I
tried college for a year. Total bust. Everything you wanna learn, you could just
look up online. I know how to open champagne with a sword.`
        },

        // üî§ Diction & Articulation
        {
          id: 'diction-elaine',
          title: 'üî§ Diction ‚Äî Elaine (The Graduate)',
          description: 'Crisp consonants; clear phrasing',
          content: `Well nothing's perfect Benjamin. I wish my mother didn't drink so much. I wish I'd
never fallen out of that tree and broken my thumb because it so affects my
fingering I'll probably never play the violin as well as I'd love to but that's about it
for the bullshit, Benjamin. It's only bullshit if you let it pile up. Heaven's in the
details. Someone said that. I think Robert Frost said that. I was in this diner with
my roommate Diane? And this guy came along with a goat on a rope and it turns
out the reason he's got a little goat on a rope is that he was thrown out the day
before for bringing in his dog? But the point is that Diane had stood up to leave
when she saw the man walk in and she sat straight down again and said, well if
there's a goat I think I'll have dessert. And that's why I love Diane, because if you
think like that you not only notice more little goats, you get more dessert.`
        },
        {
          id: 'diction-gwendolen',
          title: 'üî§ Diction ‚Äî Gwendolen (The Importance of Being Earnest)',
          description: 'Elegant diction; precise rhythm',
          content: `Oh! It is strange he never mentioned to me that he had a ward. How secretive of
him! He grows more interesting hourly. I am not sure, however, that the news
inspires me with feelings of unmixed delight. I am very fond of you, Cecily; I have
liked you ever since I met you! But I am bound to state that now that I know that
you are Mr. Worthing's ward, I cannot help expressing a wish you were‚Äîwell,
just a little older than you seem to be‚Äîand not quite so very alluring in
appearance. In fact, if I may speak candidly‚Äî [...] Well, to speak with perfect
candour, Cecily, I wish that you were fully forty-two, and more than usually plain
for your age. Ernest has a strong upright nature. He is the very soul of truth and
honour. Disloyalty would be as impossible to him as deception. But even men of
the noblest possible moral character are extremely susceptible to the influence of
the physical charms of others. Modern, no less than Ancient History, supplies us
with many most painful examples of what I refer to. If it were not so, indeed,
History would be quite unreadable.`
        },

        // üß© Syllable Separation
        {
          id: 'syllable-dont-look',
          title: "üß© Syllable Separation ‚Äî 'Don't Look At Me' (Joseph Arnone)",
          description: 'Deliberate syllable breaks',
          content: `Don't look at me. You. Eh, eh, eh...when I ad-dress you, do not look at me. No
eye con-tact. Is that un-der-stood? Look a-way. (beat) O-kay, look at me now.
(snaps her fin-gers) I told you not to look at me. E-ven if I tell you to look at me,
do not look at me. Un-der-stood? Good, good dar-ling.

Oh! I have some-thing in my eye, can you help me? (point-ing) Look-ing,
look-ing, look-ing! NO look-ing un-der all cir-cum-stan-ces.

You must raise up that at-ten-tion span of yours. A fish could re-tain more
dar-ling. That is true. I have read it. Less at-ten-tion span than a fish.
Do not let that be you dar-ling.`
        },
        {
          id: 'syllable-eliza',
          title: 'üß© Syllable Separation ‚Äî Eliza Doolittle (My Fair Lady)',
          description: 'Break into beats; clear stress',
          content: `My aunt died of in-flu-en-za, so they said. But it's my be-lief they done the old
wo-man in. Yes Lord love you! Why should she die of in-flu-en-za when she come
through diph-the-ri-a right e-nough the year be-fore? Fair-ly blue with it she was.
They all thought she was dead. But my fa-ther, he kept la-dling gin down her
throat. Then she come to so sud-den that she bit the bowl off the spoon. Now,
what would you call a wo-man with that strength in her have to die of in-flu-en-za,
and what be-come of her new straw hat that should have come to me?
Some-bo-dy pinched it, and what I say is, them that pinched it, done her in. Them
she lived with would have killed her for a hat-pin, let a-lone a hat. And as for
fa-ther la-dling the gin down her throat, it would-n't have killed her. Not her. Gin
was as mo-ther's milk to her. Be-sides, he's poured so much down his own throat
that he knew the good of it.`
        },
      ];

      // -------- Audio init (mic + analyser) --------
      const initAudio = useCallback(async () => {
        try {
          if (!audioContextRef.current) {
            audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
          }
          await audioContextRef.current.resume();

          const stream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
          });
          micStreamRef.current = stream;
          setMicPermission('granted');

          const source = audioContextRef.current.createMediaStreamSource(stream);
          analyserRef.current = audioContextRef.current.createAnalyser();
          analyserRef.current.fftSize = 2048;
          source.connect(analyserRef.current);

          setAudioInitialized(true);
          startPitchDetection();
        } catch (err) {
          console.error('Microphone error:', err);
          setMicPermission('denied');
        }
      }, []);

      // -------- Pitch detection (simple peak) --------
      const startPitchDetection = useCallback(() => {
        if (!analyserRef.current || !audioContextRef.current) return;
        const bufferLength = analyserRef.current.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const detect = () => {
          if (!analyserRef.current) return;
          analyserRef.current.getByteFrequencyData(dataArray);

          let maxValue = 0, maxIndex = 0;
          for (let i = 0; i < bufferLength; i++) {
            if (dataArray[i] > maxValue) { maxValue = dataArray[i]; maxIndex = i; }
          }

          if (maxValue > 50) {
            const nyquist = audioContextRef.current.sampleRate / 2;
            const frequency = (maxIndex * nyquist) / bufferLength;
            if (frequency > 80 && frequency < 500) setCurrentPitch(Math.round(frequency));
          } else {
            setCurrentPitch(0);
          }
          pitchDetectionRef.current = requestAnimationFrame(detect);
        };
        detect();
      }, []);

      // -------- Drone controls (smoother, volume 0‚Äì200%) --------
      const startDrone = useCallback(async () => {
        if (!audioContextRef.current) {
          audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
        }
        await audioContextRef.current.resume();

        try {
          const ctx = audioContextRef.current;

          const osc = ctx.createOscillator();
          osc.type = 'sine';
          osc.frequency.value = notes[selectedNote];

          const comp = ctx.createDynamicsCompressor();
          comp.threshold.value = -24;
          comp.knee.value = 30;
          comp.ratio.value = 4;
          comp.attack.value = 0.003;
          comp.release.value = 0.25;

          const master = ctx.createGain();
          master.gain.value = 0; // fade-in from zero

          osc.connect(comp);
          comp.connect(master);
          master.connect(ctx.destination);

          const now = ctx.currentTime;
          master.gain.setValueAtTime(0, now);
          master.gain.linearRampToValueAtTime(volume, now + 0.2);

          osc.start();

          oscillatorRef.current = osc;
          compressorRef.current = comp;
          gainNodeRef.current = master;
          setIsDronePlaying(true);
        } catch (error) {
          console.error('Drone error:', error);
        }
      }, [selectedNote, volume]);

      const stopDrone = useCallback(() => {
        const ctx = audioContextRef.current;
        if (oscillatorRef.current && gainNodeRef.current && ctx) {
          const now = ctx.currentTime;
          try {
            gainNodeRef.current.gain.cancelScheduledValues(now);
            gainNodeRef.current.gain.setTargetAtTime(0, now, 0.05); // gentle fade-out
            oscillatorRef.current.stop(now + 0.15);
          } catch {}
        }
        try {
          oscillatorRef.current?.disconnect();
          compressorRef.current?.disconnect();
          gainNodeRef.current?.disconnect();
        } catch {}
        oscillatorRef.current = null;
        compressorRef.current = null;
        gainNodeRef.current = null;
        setIsDronePlaying(false);
      }, []);

      // live volume updates while playing
      useEffect(() => {
        try { localStorage.setItem('vt_volume', String(volume)); } catch {}
        if (gainNodeRef.current && audioContextRef.current) {
          const now = audioContextRef.current.currentTime;
          gainNodeRef.current.gain.cancelScheduledValues(now);
          gainNodeRef.current.gain.setTargetAtTime(volume, now, 0.01);
        }
      }, [volume]);

      useEffect(() => {
        initAudio();
        return () => {
          if (pitchDetectionRef.current) cancelAnimationFrame(pitchDetectionRef.current);
          if (oscillatorRef.current) { try { oscillatorRef.current.stop(); } catch {} }
          if (micStreamRef.current) micStreamRef.current.getTracks().forEach(t => t.stop());
          if (audioContextRef.current) { try { audioContextRef.current.close(); } catch {} }
        };
      }, [initAudio]);

      const getPitchColor = () => {
        if (currentPitch === 0) return 'bg-gray-300';
        const target = notes[selectedNote];
        const diff = Math.abs(currentPitch - target);
        if (diff < 5)  return 'bg-svl-blue';
        if (diff < 15) return 'bg-svl-yellow';
        return 'bg-svl-orange';
      };

      const getPitchStatus = () => {
        if (currentPitch === 0) return '---';
        const target = notes[selectedNote];
        const diff = currentPitch - target;
        if (Math.abs(diff) < 5) return `${currentPitch}`;
        if (diff > 0) return `${currentPitch}‚Üì`;
        return `${currentPitch}‚Üë`;
      };

      const getFontSizeClass = () => {
        switch (fontSize) {
          case 'small': return 'text-base';
          case 'large': return 'text-xl';
          case 'xlarge': return 'text-2xl';
          default: return 'text-lg';
        }
      };

      return (
        <div className="app-shell safe-top safe-bottom">
          {/* Header with SVL branding */}
          <header className="bg-svl-beige shadow-sm sticky top-0 z-50 safe-top border-b border-svl-purple/20">
            <div className="desktop-container px-4 py-3">
              <div className="flex items-center justify-between gap-3">
                <div className="flex items-center gap-3">
                  <img
                    src="https://www.seattlevoicelab.com/wp-content/uploads/2023/05/SVL_LogoSignature.png"
                    alt="Seattle Voice Lab"
                    className="h-8 md:h-10"
                  />
                  <div>
                    <h1 className="font-display text-xl md:text-2xl lg:text-3xl font-bold text-svl-grey">Voice Training Reader</h1>
                    <p className="text-xs md:text-sm text-svl-grey/70">Practice pitch while reading</p>
                  </div>
                </div>
                {!audioInitialized && (
                  <button
                    onClick={initAudio}
                    className="px-3 py-2 rounded-lg bg-svl-purple text-white text-sm hover:opacity-90"
                  >Enable Audio</button>
                )}
              </div>
            </div>
          </header>

          {/* Main (fit-to-screen; internal scroll only) */}
          <div className="main-area bg-gradient-to-b from-svl-beige to-svl-beige">
            <div className="desktop-container p-4 h-full min-h-0">
              {!selectedReading ? (
                <div className="grid lg:grid-cols-2 gap-6 h-full min-h-0">
                  {/* Pitch Control */}
                  <div className="panel bg-white rounded-xl shadow-lg p-4 md:p-6 border border-svl-purple/10">
                    <h2 className="font-display text-lg md:text-xl font-semibold mb-4 text-svl-grey">üéØ Pitch Control</h2>

                    {/* Target Note */}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-svl-grey mb-2">üéµ Target Note</label>
                      <select
                        value={selectedNote}
                        onChange={(e) => setSelectedNote(e.target.value)}
                        className="w-full p-3 text-base md:text-lg border border-svl-purple/30 rounded-lg focus:ring-2 focus:ring-svl-purple focus:border-svl-purple"
                      >
                        {Object.entries(notes).map(([note, freq]) => (
                          <option key={note} value={note}>
                            {note} ({Math.round(freq)} Hz)
                          </option>
                        ))}
                      </select>
                    </div>

                    {/* Volume */}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-svl-grey mb-2">
                        üîä Drone Volume <span className="text-svl-grey/60">({Math.round(volume * 100)}%)</span>
                      </label>
                      <input
                        aria-label="Drone volume"
                        type="range"
                        min="0"
                        max="200"
                        step="1"
                        value={Math.round(volume * 100)}
                        onChange={(e) => setVolume(parseInt(e.target.value, 10) / 100)}
                        className="w-full"
                      />
                      <div className="flex justify-between text-xs text-svl-grey/60 mt-1"><span>0%</span><span>200%</span></div>
                    </div>

                    <div className="grid grid-cols-2 gap-3 mb-4">
                      <button
                        onClick={isDronePlaying ? stopDrone : startDrone}
                        disabled={!audioInitialized}
                        className={`py-3 md:py-4 text-base md:text-lg rounded-lg font-medium transition-colors ${
                          !audioInitialized
                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            : isDronePlaying
                              ? 'bg-svl-orange text-white hover:opacity-90'
                              : 'bg-svl-purple text-white hover:opacity-90'
                        }`}
                      >
                        {isDronePlaying ? '‚èπ Stop Drone' : '‚ñ∂ Start Drone'}
                      </button>

                      <button
                        onClick={() => setShowBubble(true)}
                        disabled={!audioInitialized}
                        className={`py-3 md:py-4 text-base md:text-lg rounded-lg font-medium transition-colors ${
                          !audioInitialized
                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            : showBubble
                              ? 'bg-svl-blue text-white hover:opacity-90'
                              : 'bg-svl-pink text-svl-grey hover:opacity-95'
                        }`}
                      >
                        {showBubble ? '‚úì Monitor On' : 'üëÅ Show Monitor'}
                      </button>
                    </div>

                    {audioInitialized && (
                      <div className="mt-auto">
                        <div className="text-center">
                          <div className="text-sm text-svl-grey/70">Current Pitch</div>
                          <div className={`text-2xl md:text-3xl font-bold ${
                            currentPitch === 0 ? 'text-gray-400' :
                            Math.abs(currentPitch - notes[selectedNote]) < 5 ? 'text-svl-blue' :
                            Math.abs(currentPitch - notes[selectedNote]) < 15 ? 'text-svl-yellow' : 'text-svl-orange'
                          }`}>
                            {currentPitch > 0 ? `${currentPitch} Hz` : 'No signal'}
                          </div>
                          <div className="text-xs text-svl-grey/60 mt-1">
                            Target: {Math.round(notes[selectedNote])} Hz
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Reading Selection */}
                  <div className="panel bg-white rounded-xl shadow-lg p-4 md:p-6 border border-svl-purple/10">
                    <h2 className="font-display text-lg md:text-xl font-semibold mb-4 text-svl-grey">üìö Select Reading Material</h2>
                    <div className="space-y-3">
                      {readings.map(reading => (
                        <button
                          key={reading.id}
                          onClick={() => setSelectedReading(reading)}
                          className="w-full text-left p-3 md:p-4 border border-svl-purple/20 rounded-lg hover:bg-svl-beige transition-colors focus:ring-2 focus:ring-svl-purple focus:outline-none"
                        >
                          <div className="font-semibold text-base md:text-lg text-svl-grey">{reading.title}</div>
                          <div className="text-xs md:text-sm text-svl-grey/70 mt-1">{reading.description}</div>
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              ) : (
                /* Reading View */
                <div className="reader-panel bg-white rounded-xl shadow-lg p-4 md:p-6 lg:p-8 h-full border border-svl-purple/10">
                  <div className="flex flex-col sm:flex-row justify-between items-start mb-4 gap-2">
                    <div>
                      <button
                        onClick={() => setSelectedReading(null)}
                        className="text-svl-purple hover:opacity-90 mb-2 transition-colors"
                      >
                        ‚Üê Back
                      </button>
                      <h2 className="font-display text-lg md:text-xl font-semibold text-svl-grey">{selectedReading.title}</h2>
                      <p className="text-xs text-svl-grey/60">{selectedReading.description}</p>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          const sizes = ['small', 'medium', 'large', 'xlarge'];
                          const current = sizes.indexOf(fontSize);
                          setFontSize(sizes[(current + 1) % sizes.length]);
                        }}
                        className="px-4 py-2 bg-svl-yellow text-svl-grey hover:opacity-90 rounded-lg text-sm transition-colors"
                      >
                        Aa
                      </button>
                    </div>
                  </div>

                  <div className={`reader-content reading-text ${getFontSizeClass()} text-svl-grey whitespace-pre-wrap`}>
                    {selectedReading.content}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Floating Bubble */}
          {showBubble && (
            <div className="floating-bubble">
              {!bubbleExpanded ? (
                <button
                  onClick={() => setBubbleExpanded(true)}
                  className={`w-20 h-16 rounded-full shadow-lg flex items-center justify-center text-white font-bold text-sm pitch-indicator ${getPitchColor()}`}
                  aria-label="Open pitch monitor"
                >
                  {getPitchStatus()}
                </button>
              ) : (
                <div className="bg-white rounded-2xl shadow-xl p-4 w-56 border border-svl-purple/10">
                  <div className="flex justify-between items-center mb-3">
                    <span className="font-semibold text-sm text-svl-grey">Pitch Monitor</span>
                    <button onClick={() => setBubbleExpanded(false)} className="text-svl-grey text-xl" aria-label="Close">√ó</button>
                  </div>

                  <div className="text-center mb-3">
                    <div className={`text-2xl font-bold ${
                      currentPitch === 0 ? 'text-gray-400' :
                      Math.abs(currentPitch - notes[selectedNote]) < 5 ? 'text-svl-blue' :
                      Math.abs(currentPitch - notes[selectedNote]) < 15 ? 'text-svl-yellow' : 'text-svl-orange'
                    }`}>
                      {currentPitch > 0 ? `${currentPitch} Hz` : '---'}
                    </div>
                    <div className="text-xs text-svl-grey/60">Target: {selectedNote} ({Math.round(notes[selectedNote])} Hz)</div>
                  </div>

                  {/* Quick volume in bubble */}
                  <div className="mb-3">
                    <label className="block text-xs text-svl-grey mb-1">
                      üîä Volume <span className="text-svl-grey/60">({Math.round(volume * 100)}%)</span>
                    </label>
                    <input
                      aria-label="Drone volume (bubble)"
                      type="range"
                      min="0"
                      max="200"
                      step="1"
                      value={Math.round(volume * 100)}
                      onChange={(e) => setVolume(parseInt(e.target.value, 10) / 100)}
                      className="w-full"
                    />
                  </div>

                  <div className="flex gap-2">
                    <button
                      onClick={isDronePlaying ? stopDrone : startDrone}
                      className={`flex-1 py-2 rounded-lg text-sm text-white ${isDronePlaying ? 'bg-svl-orange' : 'bg-svl-purple'} hover:opacity-90`}
                    >
                      {isDronePlaying ? 'Mute Drone' : 'Play Drone'}
                    </button>
                    <button
                      onClick={() => { setShowBubble(false); setBubbleExpanded(false); }}
                      className="px-3 py-2 bg-svl-grey text-white rounded-lg text-sm hover:opacity-90"
                    >
                      Hide
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<VoiceTrainingReader />);

    // PWA Service Worker Registration (HTTPS only)
    if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
      window.addEventListener('load', () => {
        const swCode = `
          const CACHE_NAME = 'voice-trainer-v1';
          const urlsToCache = [
            './',
            'https://unpkg.com/react@18/umd/react.production.min.js',
            'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
            'https://unpkg.com/@babel/standalone/babel.min.js',
            'https://cdn.tailwindcss.com',
            'https://www.seattlevoicelab.com/wp-content/uploads/2023/05/SVL_LogoSignature.png'
          ];
          self.addEventListener('install', event => {
            event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
          });
          self.addEventListener('fetch', event => {
            event.respondWith(caches.match(event.request).then(r => r || fetch(event.request)));
          });
        `;
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).catch(() => {
          console.log('PWA features not available in this environment');
        });
      });
    }
  </script>
</body>
</html>
